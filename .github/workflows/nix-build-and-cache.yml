name: "Build and Cache"
on:
  pull_request:
  push:
    branches-ignore:
      # ignore automated update branches, rely on pull_request hook
      - 'automation/**'
      - 'dependabot/**'
jobs:
  build-macos-home-manager:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: mrjones2014-dotfiles
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - name: build all definitions
        run: nix run github:Mic92/nix-fast-build -L -- --skip-cached --no-download --no-nom --eval-workers 1 --eval-max-memory-size 2048 --flake .#homeConfigurations.mac.activationPackage
  build-nixos-server:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v30
      with:
        extra_nix_config: |
          accept-flake-config = true
    - uses: cachix/cachix-action@v15
      with:
        name: mrjones2014-dotfiles
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: build all definitions
      run: nix run github:Mic92/nix-fast-build -L -- --skip-cached --no-download --no-nom --eval-workers 1 --eval-max-memory-size 2048 --flake .#nixosConfigurations.server.config.system.build.toplevel
  build-nixos-pc:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v30
      with:
        extra_nix_config: |
          accept-flake-config = true
    - uses: cachix/cachix-action@v15
      with:
        name: mrjones2014-dotfiles
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: build all definitions
      run: nix run github:Mic92/nix-fast-build -L -- --skip-cached --no-download --no-nom --eval-workers 1 --eval-max-memory-size 2048 --flake .#nixosConfigurations.pc.config.system.build.toplevel
  build-nixos-laptop:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v30
      with:
        extra_nix_config: |
          accept-flake-config = true
    - uses: cachix/cachix-action@v15
      with:
        name: mrjones2014-dotfiles
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: build all definitions
      run: nix run github:Mic92/nix-fast-build -L -- --skip-cached --no-download --no-nom --eval-workers 1 --eval-max-memory-size 2048 --flake .#nixosConfigurations.laptop.config.system.build.toplevel
